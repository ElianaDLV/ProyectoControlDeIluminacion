<script>
    const ctx = document.getElementById('capacidadChart').getContext('2d');
    const capacidadChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'Nivel de Luz',
                data: [], // Usaremos objetos {x: timestamp, y: capacidad}
                borderColor: 'rgba(149, 165, 166, 1)', // Gris azulado
                borderWidth: 2,
                fill: false,
                tension: 0.3, // Curvatura suave en las líneas
                pointRadius: 3,
                pointBackgroundColor: 'rgba(149, 165, 166, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#ffffff'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: '#343a40',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff'
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            scales: {
                x: { 
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: {
                            minute: 'dd/MM/yyyy HH:mm'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Fecha y Hora',
                        color: '#ffffff',
                        font: {
                            size: 14
                        }
                    },
                    grid: {
                        color: '#343a40'
                    },
                    ticks: {
                        color: '#ffffff'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nivel de Luz',
                        color: '#ffffff',
                        font: {
                            size: 14
                        }
                    },
                    grid: {
                        color: '#343a40'
                    },
                    ticks: {
                        color: '#ffffff'
                    }
                }
            }
        }
    });

    async function fetchData() {
        try {
            console.log("Iniciando fetch de datos...");
            const response = await fetch('/data');
            console.log("Respuesta de /data:", response);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log("Datos recibidos:", data);

            const dataBody = document.getElementById('data-body');
            dataBody.innerHTML = ''; // Limpiar la tabla

            const datasetsData = [];

            let lastReading = "N/A";
            let ledStatus = "N/A";

            data.forEach((item, index) => {
                // Verificar que los campos existan y sean válidos
                if (item.capacidad !== undefined && item.fecha && item.hora && item.estado_led) { 
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.capacidad}</td>
                        <td>${item.fecha}</td> <!-- Mostrar la fecha -->
                        <td>${item.hora}</td>  <!-- Mostrar la hora -->
                        <td>${item.estado_led}</td> <!-- Mostrar el estado del LED -->
                    `;
                    dataBody.appendChild(row);

                    // Agregar datos al gráfico
                    // Crear un objeto Date con la fecha y hora ya ajustadas en Argentina
                    const [day, month, year] = item.fecha.split('/');
                    const [hour, minute, second] = item.hora.split(':');
                    const timestamp = new Date(year, month - 1, day, hour, minute, second);
                    datasetsData.push({
                        x: timestamp,
                        y: item.capacidad
                    });

                    // Actualizar la última lectura y estado del LED
                    if (index === 0) { // Solo la primera es la más reciente
                        lastReading = item.capacidad;
                        ledStatus = item.estado_led;
                    }
                } else {
                    console.warn("Datos incompletos:", item);
                }
            });

            // Actualizar el gráfico
            capacidadChart.data.datasets[0].data = datasetsData;
            capacidadChart.update();

            // Actualizar las tarjetas informativas
            document.getElementById('last-reading').innerText = `Nivel de Luz: ${lastReading}`;
            const ledStatusElement = document.getElementById('led-status');
            if (ledStatus.toLowerCase() === 'encendido') {
                ledStatusElement.innerHTML = `Estado LED: <i class="fas fa-lightbulb text-warning"></i> Encendido`;
            } else {
                ledStatusElement.innerHTML = `Estado LED: <i class="fas fa-lightbulb text-secondary"></i> Apagado`;
            }

            console.log("Tabla y gráfico actualizados con:", data);
        } catch (error) {
            console.error('Error al obtener los datos:', error);
        }
    }

    // Cargar los datos al inicio
    fetchData();
    // Recargar los datos cada 10 segundos
    setInterval(fetchData, 10000);
</script>
